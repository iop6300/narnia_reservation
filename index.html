<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>나니아랩 체험예약</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0; background-color: #f4f7f6;
    }
    .container {
      background-color: #ffffff; padding: 40px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center;
    }
    h1 { color: #333; margin-bottom: 10px; }
    p { color: #666; margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; text-align: left; }
    label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
    button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background-color .3s; }
    button:hover { background-color: #0056b3; }
    #message { margin-top: 16px; font-weight: 700; color: #0a8f3c; display: none; }
  </style>
</head>
<script>
/* ===== 설정값 ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-3NyxcSuT4ae-vKID-puCXh81IXh53lhbiYfifAe3mphkeOJ6XlZ6GF1sLr2K6oXfC0suC4HujR2m/pub?gid=1837035928&single=true&output=csv"; // 예) 구글시트 웹게시 CSV, 또는 raw.githubusercontent.com 경로
const MAX_PEOPLE = 10;
/* ================== */

function normalize(s) {
  if (s == null) return "";
  // BOM, NBSP, 전각공백 등 제거 + 앞뒤 공백 제거
  return String(s)
    .replace(/^\uFEFF/, "")
    .replace(/\u00A0/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

// 가장 관대한 CSV 파서(따옴표/쉼표 단순 지원)
function parseCSV(text) {
  // BOM 제거
  text = text.replace(/^\uFEFF/, "");
  const rows = [];
  let i = 0, inQuotes = false, field = "", row = [];
  while (i < text.length) {
    const ch = text[i];
    if (ch === '"') {
      if (inQuotes && text[i+1] === '"') { field += '"'; i += 2; continue; }
      inQuotes = !inQuotes; i++; continue;
    }
    if (!inQuotes && (ch === "," || ch === "\t")) { // 쉼표/탭 모두 허용
      row.push(normalize(field)); field = ""; i++; continue;
    }
    if (!inQuotes && (ch === "\n" || ch === "\r")) {
      // CRLF/LF 처리
      if (ch === "\r" && text[i+1] === "\n") i++;
      row.push(normalize(field)); field = "";
      if (row.length && row.some(x=>x.length>0)) rows.push(row);
      row = []; i++; continue;
    }
    field += ch; i++;
  }
  // 마지막 필드
  if (field.length || row.length) {
    row.push(normalize(field)); 
    if (row.length && row.some(x=>x.length>0)) rows.push(row);
  }
  return rows;
}

function log(...args){ console.log("[예약마감]", ...args); }

async function fetchCSV(url) {
  // Google Drive 공유 URL은 직접 다운로드 링크로 변환 필요
  // 예: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
  //  → https://drive.google.com/uc?export=download&id=FILE_ID
  if (/drive\.google\.com\/file\/d\//.test(url)) {
    const id = url.match(/file\/d\/([^/]+)/)?.[1];
    if (id) url = `https://drive.google.com/uc?export=download&id=${id}`;
  }

  const res = await fetch(url + (url.includes("?") ? "&" : "?") + "_ts=" + Date.now(), {
    redirect: "follow" // 리다이렉트 허용
  });
  if (!res.ok) throw new Error(`CSV fetch 실패: ${res.status} ${res.statusText}`);
  return await res.text();
}

function applyCounts(countMap) {
  const select = document.getElementById("slot");
  if (!select) { log("select#slot 없음"); return; }

  [...select.options].forEach(opt => {
    if (!opt.value) return;
    // value가 없으면 text를 사용
    const key = normalize(opt.value || opt.textContent);
    const cnt = Number(countMap.get(key) || 0);
    if (cnt >= MAX_PEOPLE) {
      opt.disabled = true;
      // 이미 (마감) 표시가 있으면 중복 방지
      if (!/\(마감\)$/.test(opt.textContent)) {
        opt.textContent = `${normalize(opt.textContent)} (마감)`;
      }
    } else {
      opt.disabled = false;
      // (마감) 표시 제거
      opt.textContent = normalize(opt.textContent).replace(/\s*\(마감\)$/, "");
    }
  });

  // 이미 선택된 옵션이 마감되었다면 초기화
  if (select.selectedOptions[0]?.disabled) {
    select.value = "";
  }
}

async function refreshCloseSlots() {
  try {
    log("CSV 불러오는 중…", CSV_URL);
    const csv = await fetchCSV(CSV_URL);
    const rows = parseCSV(csv);
    if (!rows.length) { log("CSV 파싱 결과 없음"); return; }

    const header = rows[0].map(normalize);
    // 헤더 후보 여러 개 지원(예약 시간/시간/slot, 인원수/count)
    const timeIdx =
      header.findIndex(h => /예약\s*시간|시간|slot/i.test(h)) ?? -1;
    const countIdx =
      header.findIndex(h => /인원|인원수|count/i.test(h)) ?? -1;

    if (timeIdx === -1 || countIdx === -1) {
      log("헤더 감지 실패. 헤더:", header);
      return;
    }

    const countMap = new Map();
    rows.slice(1).forEach(r => {
      const t = normalize(r[timeIdx]);
      const c = Number(normalize(r[countIdx])) || 0;
      if (t) countMap.set(t, c);
    });

    log("집계:", Object.fromEntries(countMap));
    applyCounts(countMap);
  } catch (e) {
    console.error("[예약마감] 에러:", e);
  }
}

// 초기 1회 + 주기 갱신(60초)
refreshCloseSlots();
setInterval(refreshCloseSlots, 60 * 1000);
</script>


  
<body>
  <div class="container">
    <h1>나니아랩 체험 예약</h1>
    <p>나만의 웹페이지/게임 만들기</p>

    <form
      action="https://docs.google.com/forms/d/e/1FAIpQLScSgLalQZ7wq4n2w8gAn04Rs4OHnRbs-nMGGV8-fyVGj2_vdA/formResponse"
      method="POST"
      target="hidden_iframe"
      onsubmit="window._submitted=true"
    >
      <div class="form-group">
        <label for="student_name">학생이름</label>
        <input type="text" id="student_name" name="entry.809640200" required placeholder="예) 김나니" />
      </div>

      <div class="form-group">
        <label for="parent_phone">보호자 연락처</label>
        <input type="tel" id="parent_phone" name="entry.543683465" required placeholder="예) 010-1234-5678" />
      </div>

      <div class="form-group">
        <label for="slot">예약 시간</label>
        <select id="slot" name="entry.1621677829" required>
          <option value="">시간 선택</option>
          <option>10:30</option>
          <option>11:00</option>
          <option>11:30</option>
          <option>12:00</option>
          <option>12:30</option>
          <option>13:00</option>
          <option>13:30</option>
          <option>14:00</option>
          <option>14:30</option>
          <option>15:00</option>
          <option>15:30</option>
          <option>16:00</option>
          <option>16:30</option>
        </select>
      </div>

      <div class="form-group">
        <label for="school_level">학교급</label>
        <select id="school_level" name="entry.261454937" required>
          <option value="">선택</option>
          <option>초등학교</option>
          <option>중학교</option>
          <option>고등학교</option>
        </select>
      </div>

      <div class="form-group">
        <label for="grade">학생 학년</label>
        <input type="text" id="grade" name="entry.156928591" required placeholder="예) 2학년" />
      </div>

      <div class="form-group">
        <label for="interest">학생 관심분야</label>
        <input type="text" id="interest" name="entry.763983283" placeholder="예) AI, 게임, 로봇 등" />
      </div>

      <button type="submit">예약하기</button>
    </form>

    <div id="message" aria-live="polite">✅ 예약이 완료되었습니다! 담당자가 확인 후 연락드립니다.</div>
  </div>

  <iframe name="hidden_iframe" style="display:none;" onload="if(window._submitted){document.getElementById('message').style.display='block';}"></iframe>
</body>
</html>
